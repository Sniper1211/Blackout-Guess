# 解决线上环境管理后台登录与登出失效问题

## 问题分析：
1. **浏览器缓存 (Browser Cache)**: 线上环境的 JS 文件（特别是 [admin.js](file:///Users/lxx/coding/Blackout-Guess/js/admin.js)）可能被浏览器强烈缓存，导致你看到的仍然是旧逻辑，无法处理登录回跳。
2. **会话初始化不彻底**: 线上环境的网络环境较本地更复杂，如果 `onAuthStateChange` 触发过晚或被拦截，页面会停留在初始的“请登录...”状态。
3. **登出逻辑阻塞**: 原有的登出代码如果遇到网络超时，可能导致后续的页面刷新逻辑无法执行，用户感觉“点不动”。
4. **重定向地址匹配**: 需要确认 Supabase 后台是否已将 `https://www.blackoutguess.site/admin.html` 加入了允许的重定向白名单。

## 技术实施方案：

### 1. 强制刷新缓存 (Cache Busting)
在 [admin.html](file:///Users/lxx/coding/Blackout-Guess/admin.html) 中为所有核心 JS 脚本添加版本号（如 `?v=4.0`），确保浏览器加载的是我刚刚修复的版本。

### 2. 增强认证逻辑稳定性
修改 [admin.js](file:///Users/lxx/coding/Blackout-Guess/js/admin.js) 中的认证初始化部分：
- **主动探测**: 页面加载时立即尝试获取当前 Session，而不只是等待事件。
- **健壮性优化**: 为哈希处理和 code 交换添加 `try...finally` 结构，确保即使清理 URL 失败，权限检查逻辑也能继续运行。
- **日志诊断**: 在生产环境下保留必要的认证阶段日志，方便通过控制台排查具体的阻塞点。

### 3. 优化登出体验
改进 [admin.js](file:///Users/lxx/coding/Blackout-Guess/js/admin.js) 的登出按钮监听器：
- 无论 `signOut()` 请求是否成功，都强制执行页面重载。
- 显式清理本地可能残留的 `sb-*-auth-token` 相关数据。

### 4. 权限反馈细化
如果权限检查失败，将区分显示“未检测到登录状态”和“账号非管理员”两种信息，不再统一显示“请登录...”。

## 关键步骤：
1. 更新 [admin.html](file:///Users/lxx/coding/Blackout-Guess/admin.html) 脚本标签。
2. 重构 [admin.js](file:///Users/lxx/coding/Blackout-Guess/js/admin.js) 的 `bindAuth` 与 `handleAuthRedirect` 函数。
3. 提交代码并推送。
4. **建议操作**: 在浏览器中使用 `Cmd + Shift + R` (Mac) 或 `Ctrl + F5` (Windows) 进行强制刷新。

请确认以上方案，我将立即开始实施。同时建议你检查一下 Supabase 的 Redirect URL 配置。
