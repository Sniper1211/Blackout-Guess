<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理员后台 | Blackout Guess</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="styles.css">
  <meta name="robots" content="noindex">
  <!-- 引入 Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="admin-page-v3">
  <!-- 侧边导航栏 -->
  <aside class="admin-sidebar">
    <div class="sidebar-header">
      <img src="favicon.svg" alt="Logo" class="sidebar-logo">
      <h2 class="sidebar-title">诗词管理</h2>
    </div>
    
    <nav class="sidebar-menu">
      <button class="menu-item active" data-tab="tab-dashboard">
        <span class="icon">📊</span> 控制台
      </button>
      <button class="menu-item" data-tab="tab-list">
        <span class="icon">📖</span> 诗词库管理
      </button>
      <button class="menu-item" data-tab="tab-calendar">
        <span class="icon">📅</span> 发布排期
      </button>
      <button class="menu-item" data-tab="tab-settings">
        <span class="icon">⚙️</span> 系统设置
      </button>
    </nav>

    <div class="sidebar-footer">
      <div id="adminUserBadge" class="user-badge">未登录</div>
      <button id="adminBtnLogout" class="logout-btn" style="display:none">退出登录</button>
    </div>
  </aside>

  <!-- 主内容区 -->
  <main class="admin-main">
    <header class="main-header">
      <div class="header-left">
        <h1 id="currentTabTitle">概览</h1>
      </div>
      <div class="header-right">
        <span id="lastUpdated" class="last-updated">最后更新: --</span>
        <button id="adminBtnLogin" class="btn btn-primary">Google 登录</button>
      </div>
    </header>

    <div id="adminGate" class="gate-message">请登录管理员账号以访问后台系统</div>

    <div id="adminContent" class="content-container" style="display:none">
      
      <!-- 选项卡 1：控制台仪表盘 -->
      <section id="tab-dashboard" class="tab-content active">
        <!-- 统计卡片行 -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-info">
              <span class="stat-label">诗词总数</span>
              <h3 id="statTotalPoems" class="stat-value">---</h3>
            </div>
            <div class="stat-icon icon-blue">📚</div>
          </div>
          <div class="stat-card">
            <div class="stat-info">
              <span class="stat-label">已发布</span>
              <h3 id="statPublishedPoems" class="stat-value">---</h3>
            </div>
            <div class="stat-icon icon-green">✅</div>
          </div>
          <div class="stat-card">
            <div class="stat-info">
              <span class="stat-label">已排期</span>
              <h3 id="statScheduledPoems" class="stat-value">---</h3>
            </div>
            <div class="stat-icon icon-amber">📅</div>
          </div>
          <div class="stat-card">
            <div class="stat-info">
              <span class="stat-label">今日参与</span>
              <h3 id="statTodayParticipation" class="stat-value">---</h3>
            </div>
            <div class="stat-icon icon-purple">👥</div>
          </div>
        </div>

        <!-- 趋势图与今日诗词 -->
        <div class="dashboard-middle-grid">
          <div class="dashboard-chart-card">
            <h3>本周参与度趋势</h3>
            <div class="chart-container">
              <canvas id="participationChart"></canvas>
            </div>
          </div>
          
          <div class="today-poem-card">
            <div class="card-header">
              <h3>今日展示诗词</h3>
              <span id="todayPoemStatus" class="status-badge status-published">已发布</span>
            </div>
            <div id="todayPoemDisplay" class="poem-preview-box">
              <div class="placeholder">正在加载今日诗词...</div>
            </div>
            <div class="card-actions">
              <button id="btnViewTodayDetail" class="btn btn-outline btn-sm">查看详情</button>
              <button id="btnChangeTodayPoem" class="btn btn-amber btn-sm">更换</button>
            </div>
          </div>
        </div>
      </section>

      <!-- 选项卡 2：题目管理 (整合已有功能) -->
      <section id="tab-list" class="tab-content">
        <div class="admin-panel">
          <div class="panel-header">
            <h3>诗词库列表</h3>
            <div class="panel-actions">
              <input type="text" id="searchQuestions" placeholder="搜索标题、内容或作者..." class="search-input">
              <button id="btnCreateNew" class="btn btn-primary">+ 新增题目</button>
            </div>
          </div>

          <div class="filter-bar">
            <div class="filter-group">
              <label>状态：</label>
              <select id="filterStatus">
                <option value="all">全部</option>
                <option value="draft">草稿</option>
                <option value="scheduled">已排期</option>
                <option value="published">已发布</option>
              </select>
            </div>
            <span class="mono" id="totalCount">共：0 条</span>
          </div>

          <div class="table-responsive">
            <table id="questionTable" class="admin-table">
              <thead>
                <tr>
                  <th style="width:40px"><input type="checkbox" id="selectAllHeader"></th>
                  <th style="width:60px">ID</th>
                  <th style="width:15%">标题</th>
                  <th>全文预览</th>
                  <th style="width:100px">作者</th>
                  <th style="width:100px">状态</th>
                  <th style="width:120px">发布日期</th>
                  <th style="width:160px">操作</th>
                </tr>
              </thead>
              <tbody>
                <!-- 数据动态填充 -->
              </tbody>
            </table>
          </div>

          <div class="pagination" id="pagination"></div>
        </div>
      </section>

      <!-- 选项卡 3：排期日历 (整合已有功能) -->
      <section id="tab-calendar" class="tab-content">
        <div class="admin-panel">
          <div class="panel-header">
            <h3>发布排期计划</h3>
            <div class="calendar-nav">
              <button id="calPrev" class="btn btn-sm">&lt;</button>
              <span id="calLabel" class="current-month-label">加载中…</span>
              <button id="calNext" class="btn btn-sm">&gt;</button>
            </div>
          </div>
          <div id="calendarGrid" class="admin-calendar-grid">
            <div class="weekday">日</div><div class="weekday">一</div><div class="weekday">二</div>
            <div class="weekday">三</div><div class="weekday">四</div><div class="weekday">五</div>
            <div class="weekday">六</div>
          </div>
        </div>
      </section>

      <!-- 选项卡 4：系统设置 -->
      <section id="tab-settings" class="tab-content">
        <div class="admin-panel">
          <h3>全局系统设置</h3>
          <div class="settings-list">
            <div class="setting-item">
              <div class="setting-info">
                <span class="setting-name">每日一题模式</span>
                <span id="dailyModeDesc" class="setting-desc">开启后系统将锁定日期题目，否则随机刷新。</span>
                <div style="margin-top: 8px;">
                  <span id="dailyModeBadge" class="badge">加载中...</span>
                </div>
              </div>
              <div class="setting-control">
                <label class="switch">
                  <input type="checkbox" id="toggleDailyMode">
                  <span class="slider round"></span>
                </label>
              </div>
            </div>
            <div class="setting-item">
              <div class="setting-info">
                <span class="setting-name">数据维护</span>
                <span class="setting-desc">一键清理重复内容或执行自动排期。</span>
              </div>
              <div class="setting-control">
                <button id="btnCleanDuplicates" class="btn btn-outline btn-sm">清理重复</button>
                <button id="btnAutoScheduleAll" class="btn btn-outline btn-sm">自动排期</button>
              </div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- 编辑模态窗 (重用之前优化的宽屏布局) -->
  <div id="editModal" class="modal">
    <div class="modal-content admin-modal">
      <div class="modal-header">
        <h3 id="modalTitle">编辑题目</h3>
        <button class="close-modal">&times;</button>
      </div>
      <form id="questionForm" class="admin-form">
        <div class="form-group form-group-content">
          <label for="qContent">正文 (每行一句)</label>
          <textarea id="qContent" required></textarea>
        </div>
        <div class="form-meta-group">
          <div class="form-row">
            <div class="form-group"><label>标题</label><input type="text" id="qTitle" required></div>
            <div class="form-group"><label>作者</label><input type="text" id="qAuthor" required></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>朝代</label><input type="text" id="qDynasty"></div>
            <div class="form-group">
              <label>类型</label>
              <select id="qType"><option value="poem">诗词</option><option value="word">词语</option></select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>状态</label>
              <select id="qStatus"><option value="draft">草稿</option><option value="scheduled">已排期</option><option value="published">已发布</option></select>
            </div>
            <div class="form-group"><label>日期</label><input type="date" id="qPublishDate"></div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>语言</label>
              <select id="qLang">
                <option value="zh-CN">简体中文</option>
                <option value="zh-TW">繁体中文</option>
                <option value="en">English</option>
              </select>
            </div>
            <div class="form-group checkbox-group" style="display:flex; align-items:flex-end; padding-bottom:10px">
              <label><input type="checkbox" id="qEnabled" checked> 启用该题目</label>
            </div>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-outline close-modal">取消</button>
          <button type="submit" class="btn btn-primary">保存修改</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toastContainer" class="toast-container"></div>

  <script>
    window.SUPABASE_URL = 'https://bejoqvymupzhtmxjxqvb.supabase.co';
    window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJlam9xdnltdXB6aHRteGp4cXZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NjY2MDEsImV4cCI6MjA3NzE0MjYwMX0.zM4iRiii069JHKZdZnmxtJIQP1Rapax-fpEwb-R5pVo';
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/env.js"></script>
  <script src="js/admin.js"></script>
</body>
</html>
