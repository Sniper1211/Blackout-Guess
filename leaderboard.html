<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>最高分排行榜</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .lb-container { max-width: 1000px; margin: 24px auto; padding: 16px; background: var(--card-background); border: 1px solid var(--border-color); border-radius: var(--border-radius); box-shadow: var(--shadow-light); }
    .lb-header { display: flex; justify-content: space-between; align-items: center; }
    .lb-title { font-size: 1.5rem; font-weight: 600; color: var(--secondary-color); }
    .lb-actions { display: flex; gap: 8px; }
    .lb-actions button, .lb-actions a { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-background); color: var(--text-color); text-decoration: none; box-shadow: var(--shadow-light); transition: var(--transition); }
    .lb-actions button:hover, .lb-actions a:hover { border-color: var(--primary-color); box-shadow: var(--shadow-medium); transform: translateY(-2px); }
    .lb-table-wrapper { margin-top: 16px; overflow-x: auto; }
    .lb-table { width: 100%; border-collapse: collapse; }
    .lb-table th, .lb-table td { border-bottom: 1px solid var(--border-color); padding: 8px; text-align: left; color: var(--text-color); white-space: nowrap; }
    .lb-empty { margin-top: 16px; color: #666; }
    .lb-loading { margin-top: 16px; color: var(--text-color); }
    .lb-error { margin-top: 16px; color: #c62828; }
    .medal { width: 2rem; display: inline-block; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div class="lb-container">
    <div class="lb-header">
      <div class="lb-title">🏆 最高分排行榜</div>
      <div class="lb-actions">
        <button id="btnRefresh">刷新</button>
        <a href="index.html" id="btnBack">返回游戏</a>
      </div>
    </div>

    <div id="lbStatus" class="lb-loading">正在加载排行榜…</div>
    <div class="lb-table-wrapper">
      <table id="lbTable" class="lb-table" aria-live="polite" style="display:none">
        <thead>
          <tr>
            <th>排名</th>
            <th>作品</th>
            <th>分数</th>
            <th>猜测</th>
            <th>用时</th>
            <th>作者</th>
            <th>日期</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="lbEmpty" class="lb-empty" style="display:none">暂无记录，先回到游戏玩一局试试吧！</div>
    <div id="lbError" class="lb-error" style="display:none"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    const medals = ['🥇','🥈','🥉'];
    const statusEl = document.getElementById('lbStatus');
    const tableEl = document.getElementById('lbTable');
    const tbodyEl = tableEl.querySelector('tbody');
    const emptyEl = document.getElementById('lbEmpty');
    const errorEl = document.getElementById('lbError');
    const btnRefresh = document.getElementById('btnRefresh');

    let isLoading = false;
    let loadingTimer = null;

    function startLoadingDots() {
      const frames = ['',' .',' ..',' ...'];
      let i = 0;
      clearLoadingDots();
      loadingTimer = setInterval(() => {
        statusEl.textContent = '正在加载排行榜' + frames[i];
        i = (i + 1) % frames.length;
      }, 400);
    }

    function clearLoadingDots() {
      if (loadingTimer) {
        clearInterval(loadingTimer);
        loadingTimer = null;
      }
    }

    function formatDate(iso) {
      try { return new Date(iso).toLocaleString(); } catch { return ''; }
    }

    function formatSeconds(sec) {
      if (typeof sec !== 'number') return '—';
      const s = Math.round(sec);
      const m = Math.floor(s / 60);
      const r = s % 60;
      return m > 0 ? `${m}分${r}秒` : `${r}秒`;
    }

    async function fetchLeaderboard(limit = 10) {
      if (isLoading) return;
      isLoading = true;
      statusEl.style.display = 'block';
      statusEl.textContent = '正在加载排行榜';
      startLoadingDots();
      tableEl.style.display = 'none';
      emptyEl.style.display = 'none';
      errorEl.style.display = 'none';
      tbodyEl.innerHTML = '';

      try {
        const url = localStorage.getItem('SUPABASE_URL');
        const key = localStorage.getItem('SUPABASE_ANON_KEY');

        let rows = null;
        if (window.supabase && url && key) {
          const client = window.supabase.createClient(url, key);
          const { data, error } = await client
            .from('game_sessions')
            .select('*')
            .order('score', { ascending: false })
            .order('created_at', { ascending: false })
            .limit(limit);
          if (error) throw new Error(error.message);
          rows = data || [];
        }

        if (!rows || rows.length === 0) {
          // 回退到本地最高分
          try {
            const highScores = JSON.parse(localStorage.getItem('highScores') || '[]');
            if (!highScores.length) {
            clearLoadingDots();
            statusEl.style.display = 'none';
            emptyEl.style.display = 'block';
            isLoading = false;
            return;
          }
            clearLoadingDots();
            statusEl.style.display = 'none';
            tableEl.style.display = 'table';
            highScores.forEach((score, index) => {
              const tr = document.createElement('tr');
              const medal = index < 3 ? medals[index] : `${index + 1}`;
              tr.innerHTML = `
                <td class="mono">${medal}</td>
                <td>《${score.title}》</td>
                <td class="mono">${score.score}</td>
                <td class="mono">${score.guessCount ?? '—'}</td>
                <td class="mono">${score.time ?? '—'}</td>
                <td class="mono">—</td>
                <td class="mono">${formatDate(score.date)}</td>
              `;
              tbodyEl.appendChild(tr);
            });
            isLoading = false;
            return;
          } catch (e) {
            errorEl.textContent = '读取本地排行榜失败';
            errorEl.style.display = 'block';
            statusEl.style.display = 'none';
            isLoading = false;
            return;
          }
        }

        // 渲染在线排行榜
        clearLoadingDots();
        statusEl.style.display = 'none';
        tableEl.style.display = 'table';
        rows.forEach((row, index) => {
          const tr = document.createElement('tr');
          const medal = index < 3 ? medals[index] : `${index + 1}`;
          tr.innerHTML = `
            <td class="mono">${medal}</td>
            <td>《${row.poem_title || '未知作品'}》</td>
            <td class="mono">${row.score}</td>
            <td class="mono">${row.guess_count ?? '—'}</td>
            <td class="mono">${formatSeconds(row.duration_seconds)}</td>
            <td>${(row.author || '') + (row.dynasty ? ` (${row.dynasty})` : '')}</td>
            <td class="mono">${formatDate(row.created_at)}</td>
          `;
          tbodyEl.appendChild(tr);
        });
      } catch (e) {
        clearLoadingDots();
        errorEl.textContent = `加载排行榜失败：${e.message || e}`;
        errorEl.style.display = 'block';
        statusEl.style.display = 'none';
      } finally {
        clearLoadingDots();
        isLoading = false;
      }
    }

    btnRefresh.addEventListener('click', () => fetchLeaderboard());
    document.addEventListener('DOMContentLoaded', () => fetchLeaderboard());
  </script>
</body>
</html>