<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>æ’è¡Œæ¦œ | å¤è¯—è¯çŒœå­—æ¸¸æˆ</title>
  <meta name="description" content="å¤è¯—è¯çŒœå­—æ¸¸æˆæ’è¡Œæ¦œï¼ŒæŸ¥çœ‹æœ€é«˜åˆ†ä¸æœ€ä½³è¿å‡»è®°å½•ã€‚" />
  <link rel="canonical" href="https://sniper1211.github.io/Blackout-Guess/leaderboard.html" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <meta property="og:title" content="æ’è¡Œæ¦œ | å¤è¯—è¯çŒœå­—æ¸¸æˆ" />
  <meta property="og:description" content="æŸ¥çœ‹æœ€é«˜åˆ†ä¸æœ€ä½³è¿å‡»è®°å½•ï¼ŒæŒ‘æˆ˜æ›´é«˜åˆ†æ•°ã€‚" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://sniper1211.github.io/Blackout-Guess/leaderboard.html" />
  <meta property="og:image" content="https://sniper1211.github.io/Blackout-Guess/favicon.svg" />
  <meta name="twitter:card" content="summary_large_image" />
  <link rel="stylesheet" href="styles.css" />
  
</head>
<body>
  <nav class="site-nav" aria-label="ä¸»è¦å¯¼èˆª">
    <a href="index.html" aria-label="è¿”å›é¦–é¡µ">é¦–é¡µ</a>
    <a href="leaderboard.html" aria-label="æŸ¥çœ‹æ’è¡Œæ¦œ" class="active">æ’è¡Œæ¦œ</a>
    <a href="help.html" aria-label="æŸ¥çœ‹æ¸¸æˆè¯´æ˜">æ¸¸æˆè¯´æ˜</a>
  </nav>
  <main>
  <div class="page-container">
    <div class="page-header">
      <div class="page-title">ğŸ† æœ€é«˜åˆ†æ’è¡Œæ¦œ</div>
      <div class="page-actions">
        <button id="btnRefresh" class="btn btn-outline">åˆ·æ–°</button>
        <a href="index.html" id="btnBack" class="btn">è¿”å›æ¸¸æˆ</a>
        <a href="help.html" class="btn">æ¸¸æˆè¯´æ˜</a>
      </div>
    </div>

    <div id="lbStatus" class="lb-loading">æ­£åœ¨åŠ è½½æ’è¡Œæ¦œâ€¦</div>
    <div class="lb-table-wrapper">
      <table id="lbTable" class="table lb-table" aria-live="polite" style="display:none">
        <thead>
          <tr>
            <th>æ’å</th>
            <th>ç”¨æˆ·å</th>
            <th>ä½œå“</th>
            <th>åˆ†æ•°</th>
            <th>çŒœæµ‹</th>
            <th>ç”¨æ—¶</th>
            <th>ä½œè€…</th>
            <th>æ—¥æœŸ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="lbEmpty" class="lb-empty" style="display:none">æš‚æ— è®°å½•ï¼Œå…ˆå›åˆ°æ¸¸æˆç©ä¸€å±€è¯•è¯•å§ï¼</div>
    <div id="lbError" class="lb-error" style="display:none"></div>
  </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    const statusEl = document.getElementById('lbStatus');
    const tableEl = document.getElementById('lbTable');
    const tbodyEl = tableEl.querySelector('tbody');
    const emptyEl = document.getElementById('lbEmpty');
    const errorEl = document.getElementById('lbError');
    const btnRefresh = document.getElementById('btnRefresh');

    let isLoading = false;
    let loadingTimer = null;

    function startLoadingDots() {
      const frames = ['',' .',' ..',' ...'];
      let i = 0;
      clearLoadingDots();
      loadingTimer = setInterval(() => {
        statusEl.textContent = 'æ­£åœ¨åŠ è½½æ’è¡Œæ¦œ' + frames[i];
        i = (i + 1) % frames.length;
      }, 400);
    }

    function clearLoadingDots() {
      if (loadingTimer) {
        clearInterval(loadingTimer);
        loadingTimer = null;
      }
    }

    function formatDate(iso) {
      try { return new Date(iso).toLocaleString(); } catch { return ''; }
    }

    function formatSeconds(sec) {
      if (typeof sec !== 'number') return 'â€”';
      const s = Math.round(sec);
      const m = Math.floor(s / 60);
      const r = s % 60;
      return m > 0 ? `${m}åˆ†${r}ç§’` : `${r}ç§’`;
    }

    async function fetchLeaderboard(limit = 10) {
      if (isLoading) return;
      isLoading = true;
      statusEl.style.display = 'block';
      statusEl.textContent = 'æ­£åœ¨åŠ è½½æ’è¡Œæ¦œ';
      startLoadingDots();
      tableEl.style.display = 'none';
      emptyEl.style.display = 'none';
      errorEl.style.display = 'none';
      tbodyEl.innerHTML = '';

      try {
        const url = localStorage.getItem('SUPABASE_URL');
        const key = localStorage.getItem('SUPABASE_ANON_KEY');

        let rows = null;
        if (window.supabase && url && key) {
          const client = window.supabase.createClient(url, key);
          const { data, error } = await client
            .from('game_sessions')
            .select('*')
            .order('score', { ascending: false })
            .order('created_at', { ascending: false })
            .limit(limit);
          if (error) throw new Error(error.message);
          rows = data || [];
        }

        if (!rows || rows.length === 0) {
          // å›é€€åˆ°æœ¬åœ°æœ€é«˜åˆ†
          try {
            const highScores = JSON.parse(localStorage.getItem('highScores') || '[]');
            if (!highScores.length) {
            clearLoadingDots();
            statusEl.style.display = 'none';
            emptyEl.style.display = 'block';
            isLoading = false;
            return;
          }
            clearLoadingDots();
            statusEl.style.display = 'none';
            tableEl.style.display = 'table';
            highScores.forEach((score, index) => {
              const tr = document.createElement('tr');
              const medal = index < 3 ? medals[index] : `${index + 1}`;
              tr.innerHTML = `
                <td class="mono">${medal}</td>
                <td class="mono">${(localStorage.getItem('username') || 'â€”')}</td>
                <td>ã€Š${score.title}ã€‹</td>
                <td class="mono">${score.score}</td>
                <td class="mono">${score.guessCount ?? 'â€”'}</td>
                <td class="mono">${score.time ?? 'â€”'}</td>
                <td class="mono">â€”</td>
                <td class="mono">${formatDate(score.date)}</td>
              `;
              tbodyEl.appendChild(tr);
            });
            isLoading = false;
            return;
          } catch (e) {
            errorEl.textContent = 'è¯»å–æœ¬åœ°æ’è¡Œæ¦œå¤±è´¥';
            errorEl.style.display = 'block';
            statusEl.style.display = 'none';
            isLoading = false;
            return;
          }
        }

        // æ¸²æŸ“åœ¨çº¿æ’è¡Œæ¦œ
        clearLoadingDots();
        statusEl.style.display = 'none';
        tableEl.style.display = 'table';
        rows.forEach((row, index) => {
          const tr = document.createElement('tr');
          const medal = index < 3 ? medals[index] : `${index + 1}`;
          tr.innerHTML = `
            <td class="mono">${medal}</td>
            <td class="mono">${row.username || 'â€”'}</td>
            <td>ã€Š${row.poem_title || 'æœªçŸ¥ä½œå“'}ã€‹</td>
            <td class="mono">${row.score}</td>
            <td class="mono">${row.guess_count ?? 'â€”'}</td>
            <td class="mono">${formatSeconds(row.duration_seconds)}</td>
            <td>${(row.author || '') + (row.dynasty ? ` (${row.dynasty})` : '')}</td>
            <td class="mono">${formatDate(row.created_at)}</td>
          `;
          tbodyEl.appendChild(tr);
        });
      } catch (e) {
        clearLoadingDots();
        errorEl.textContent = `åŠ è½½æ’è¡Œæ¦œå¤±è´¥ï¼š${e.message || e}`;
        errorEl.style.display = 'block';
        statusEl.style.display = 'none';
      } finally {
        clearLoadingDots();
        isLoading = false;
      }
    }

    btnRefresh.addEventListener('click', () => fetchLeaderboard());
    document.addEventListener('DOMContentLoaded', () => fetchLeaderboard());
  </script>
</body>
</html>